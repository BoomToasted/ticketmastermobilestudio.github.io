{% assign maxRelated = 10 %}
{% assign minCommonTags = 1 %}
{% assign maxRelatedCounter = 0 %}
{% assign outputHtml = '' %}

{% for post in site.posts %}

  {% assign sameTagCount = 0 %}
  {% assign commonTags = '' %}

  {% for category in post.categories %}
    {% if post.url != page.url and category != "blog" %}
      {% if page.categories contains category %}
        {% assign sameTagCount = sameTagCount | plus: 1 %}
      {% endif %}
    {% endif %}
  {% endfor %}

  {% for tag in post.tags %}
    {% if post.url != page.url %}
      {% if page.tags contains tag %}
        {% assign sameTagCount = sameTagCount | plus: 1 %}
      {% endif %}
    {% endif %}
  {% endfor %}

  {% if sameTagCount >= minCommonTags %}
    {% capture postItemHtml %}<li><h4><a href="{{ site.baseurl }}{{ post.url }}">{{ post.title }}</a></h4></li>{% endcapture %}
    {% assign outputHtml = outputHtml | append: postItemHtml %}
    {% assign maxRelatedCounter = maxRelatedCounter | plus: 1 %}
    {% if maxRelatedCounter >= maxRelated %}
      {% break %}
    {% endif %}
  {% endif %}

{% endfor %}

{% if outputHtml.size > 0 %}
  <h3>Related</h3>
  <ul class="related-posts">
    {{ outputHtml }}
  </ul>
{% endif %}